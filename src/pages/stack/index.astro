---
import BaseLayout from '../../layouts/BaseLayout.astro';
import StackCurrentRow from '../../components/StackCurrentRow.astro';
import StackHistoryContext from '../../components/StackHistoryContext.astro';
import { getCollection } from 'astro:content';
import { SITE_TITLE } from '../../consts';
import { FEATURES } from '../../config/features';

if (!FEATURES.stack) {
  return Astro.redirect('/');
}

type Category =
  | 'Languages'
  | 'Frameworks'
  | 'UI'
  | 'Data'
  | 'Identity'
  | 'Integrations'
  | 'Platforms/Hosting'
  | 'Infrastructure'
  | 'Tooling'
  | 'AI Tools'
  | 'AI Models/APIs';

type TechRef = string | { label: string; href?: string; tags?: Category[] };
type ResolvedTech = {
  key: string;
  label: string;
  href?: string;
  tags: Category[];
};
type StackEvent = { date: Date; title: string; note?: string; tech: TechRef[] };

type StackPeriod = {
  from: Date;
  to?: Date;
  summary?: string;
  tech?: TechRef[];
  // Backward compatible: earlier periods may still use `stack`.
  stack?: Record<Category, TechRef[]>;
  events: StackEvent[];
};

type StackContext = {
  id: string;
  title: string;
  order: number;
  periods: StackPeriod[];
};

type PeriodEvent = {
  dateIso: string;
  dateLabel: string;
  title: string;
  note?: string;
  tech: ResolvedTech[];
};

type PeriodDiff = { added: ResolvedTech[]; removed: ResolvedTech[] };

type ResolvedPeriod = {
  from: Date;
  to?: Date;
  fromIso: string;
  toIso?: string;
  rangeLabel: string;
  summary?: string;
  tech: ResolvedTech[];
  events: PeriodEvent[];
  diff?: PeriodDiff;
};

const CATEGORY_ORDER: Category[] = [
  'Languages',
  'Frameworks',
  'UI',
  'Data',
  'Identity',
  'Integrations',
  'Platforms/Hosting',
  'Infrastructure',
  'Tooling',
  'AI Tools',
  'AI Models/APIs',
];

const allContexts = await getCollection('stacks');
const contexts: StackContext[] = allContexts
  .filter((c) => c.data.published !== false)
  .map((c) => ({
    id: c.id,
    title: c.data.title,
    order: c.data.order,
    periods: c.data.periods,
  }))
  .sort((a, b) => a.order - b.order || a.title.localeCompare(b.title));

const allTech = await getCollection('tech');
const techById = new Map(
  allTech.filter((t) => t.data.published !== false).map((t) => [t.id, t.data])
);

function formatMonthYear(date: Date) {
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    year: 'numeric',
  }).format(date);
}

function formatRange(from: Date, to: Date | undefined) {
  const fromLabel = formatMonthYear(from);
  if (!to) return `${fromLabel} – present`;
  const toLabel = formatMonthYear(to);
  if (fromLabel === toLabel) return fromLabel;
  return `${fromLabel} – ${toLabel}`;
}

function resolveRefWithTags(ref: TechRef): ResolvedTech {
  if (typeof ref === 'string') {
    const found = techById.get(ref);
    if (found) {
      const tags = Array.isArray(found.tags)
        ? (found.tags as Category[])
        : found.category
          ? ([found.category] as Category[])
          : ([] as Category[]);
      return { key: `id:${ref}`, label: found.title, href: found.href, tags };
    }
    return { key: `id:${ref}`, label: ref, tags: [] };
  }
  return {
    key: `label:${ref.label}`,
    label: ref.label,
    href: ref.href,
    tags: ref.tags ?? [],
  };
}

function resolvePeriod(period: StackPeriod): ResolvedPeriod {
  const legacyFlatFromStack: TechRef[] = [];
  if (period.stack) {
    for (const cat of CATEGORY_ORDER) {
      const items = period.stack[cat] ?? [];
      for (const item of items) {
        if (typeof item === 'string') legacyFlatFromStack.push(item);
        else legacyFlatFromStack.push({ ...item, tags: item.tags ?? [cat] });
      }
    }
  }

  const raw =
    period.tech && period.tech.length > 0 ? period.tech : legacyFlatFromStack;
  const tech = raw.map(resolveRefWithTags);

  const events = [...(period.events ?? [])]
    .sort((a, b) => b.date.valueOf() - a.date.valueOf())
    .map((ev) => ({
      dateIso: ev.date.toISOString(),
      dateLabel: formatMonthYear(ev.date),
      title: ev.title,
      note: ev.note,
      tech: (ev.tech ?? []).map(resolveRefWithTags),
    }));

  return {
    from: period.from,
    to: period.to,
    fromIso: period.from.toISOString(),
    toIso: period.to?.toISOString(),
    rangeLabel: formatRange(period.from, period.to),
    summary: period.summary,
    tech,
    events,
  };
}

function computeDiff(prev: ResolvedPeriod | undefined, cur: ResolvedPeriod) {
  if (!prev) return undefined;
  const prevKeys = new Set(prev.tech.map((t) => t.key));
  const curKeys = new Set(cur.tech.map((t) => t.key));
  return {
    added: cur.tech.filter((t) => !prevKeys.has(t.key)),
    removed: prev.tech.filter((t) => !curKeys.has(t.key)),
  };
}

function computeViewForContext(ctx: StackContext) {
  const sorted = [...ctx.periods].sort(
    (a, b) => a.from.valueOf() - b.from.valueOf()
  );
  const resolved = sorted.map(resolvePeriod);
  const diffs = resolved.map((p, idx) =>
    computeDiff(idx > 0 ? resolved[idx - 1] : undefined, p)
  );
  const withDiff = resolved.map((p, idx) => ({ ...p, diff: diffs[idx] }));

  const currentIndex = (() => {
    for (let i = withDiff.length - 1; i >= 0; i -= 1) {
      if (!withDiff[i].to) return i;
    }
    return withDiff.length - 1;
  })();

  const current = withDiff[currentIndex];
  const past = withDiff
    .filter((_, idx) => idx !== currentIndex)
    .sort((a, b) => b.from.valueOf() - a.from.valueOf());

  return { current, past };
}

function accentFor(id: string) {
  // Deterministic accent per stack context. Kept subtle by default; variants can
  // decide how loud to render it.
  let h = 0;
  for (let i = 0; i < id.length; i += 1) {
    h = (h * 31 + id.charCodeAt(i)) >>> 0;
  }
  const hue = h % 360;
  // Avoid neon-by-default; keep in a printable, confident range.
  return `hsl(${hue} 68% 42%)`;
}
---

<BaseLayout
  title={`Stack · ${SITE_TITLE}`}
  description="Current and previous tech stacks across contexts and projects."
>
  <main>
    <section class="intro">
      <h1>Stack</h1>
      <p>
        Current stacks in compact form, plus a foldable history for older
        periods.
      </p>
    </section>

    {
      contexts.length === 0 ? (
        <p class="empty">No stack contexts published yet.</p>
      ) : (
        <div
          class="stack-wrap"
          data-stack-variant="v2"
          data-tag-shape="ultra"
          data-tag-style="tinted"
          data-rail-width="thin"
          data-rail-color="context"
          data-tech-preview="wrap"
        >
          <section class="variant" aria-label="Tag controls">
            <div class="variant-control">
              <p class="variant-label">Tech Preview</p>
              <div
                class="variant-buttons"
                role="group"
                aria-label="Choose folded tech preview"
              >
                <button
                  type="button"
                  data-tech-preview-btn="wrap"
                  data-active="true"
                >
                  Wrap
                </button>
                <button type="button" data-tech-preview-btn="truncate">
                  Fade + Count
                </button>
              </div>
            </div>

            <div class="variant-control">
              <p class="variant-label">Stack Rail</p>
              <div
                class="variant-buttons"
                role="group"
                aria-label="Choose stack rail thickness"
              >
                <button
                  type="button"
                  data-rail-width-btn="thin"
                  data-active="true"
                >
                  Thin
                </button>
                <button type="button" data-rail-width-btn="thick">
                  Thick
                </button>
                <button type="button" data-rail-width-btn="none">
                  None
                </button>
              </div>
              <div
                class="variant-buttons"
                role="group"
                aria-label="Choose stack rail color"
              >
                <button
                  type="button"
                  data-rail-color-btn="context"
                  data-active="true"
                >
                  Multicolor
                </button>
                <button type="button" data-rail-color-btn="black">
                  Black
                </button>
                <button type="button" data-rail-color-btn="blue">
                  Blue
                </button>
              </div>
            </div>

            <div class="variant-control">
              <p class="variant-label">Tag Shape</p>
              <div
                class="variant-buttons tag-shape-buttons"
                role="group"
                aria-label="Choose tag shape"
              >
                <button
                  type="button"
                  data-tag-shape-btn="ultra"
                  data-active="true"
                >
                  Ultra
                </button>
                <button type="button" data-tag-shape-btn="ultra-rounded">
                  Rounded
                </button>
                <button type="button" data-tag-shape-btn="ultra-soft">
                  Soft
                </button>
                <button type="button" data-tag-shape-btn="ultra-slab">
                  Ultra Slab
                </button>
              </div>
            </div>

            <div class="variant-control">
              <p class="variant-label">Tag Style</p>
              <div
                class="variant-buttons"
                role="group"
                aria-label="Choose tag style"
              >
                <button
                  type="button"
                  data-tag-style-btn="tinted"
                  data-active="true"
                >
                  Tinted
                </button>
                <button type="button" data-tag-style-btn="clean">
                  Clean
                </button>
                <button type="button" data-tag-style-btn="clean-tinted-hover">
                  Clean + Tint Hover
                </button>
              </div>
            </div>
          </section>

          <section class="current" aria-label="Current stacks">
            <header class="section-head">
              <h2>Current</h2>
              <p>One line each. Expand a row for details.</p>
            </header>

            <div class="rows">
              {contexts.map((ctx) => {
                const view = computeViewForContext(ctx);
                return (
                  <div
                    class="row-wrap"
                    data-stack-key={ctx.id}
                    style={`--stack-accent: ${accentFor(ctx.id)};`}
                  >
                    <StackCurrentRow
                      contextId={ctx.id}
                      title={ctx.title}
                      rangeLabel={view.current.rangeLabel}
                      summary={view.current.summary}
                      tech={view.current.tech}
                      events={view.current.events}
                    />
                  </div>
                );
              })}
            </div>
          </section>

          <section class="previous" aria-label="Previous stacks">
            <header class="section-head">
              <h2>Previous</h2>
              <p>Foldable history per context. Diffs show how it changed.</p>
            </header>

            <div class="history-list">
              {contexts.map((ctx) => {
                const view = computeViewForContext(ctx);
                return (
                  <div
                    class="row-wrap"
                    data-stack-key={ctx.id}
                    style={`--stack-accent: ${accentFor(ctx.id)};`}
                  >
                    <StackHistoryContext
                      contextId={ctx.id}
                      title={ctx.title}
                      periods={view.past.map((p) => ({
                        fromIso: p.fromIso,
                        toIso: p.toIso,
                        rangeLabel: p.rangeLabel,
                        summary: p.summary,
                        tech: p.tech,
                        events: p.events,
                        diff: p.diff,
                      }))}
                    />
                  </div>
                );
              })}
            </div>
          </section>
        </div>
      )
    }

    <script is:inline>
      function initStackControls() {
        const root = document.querySelector('[data-stack-variant]');
        if (!root) return;
        if (root.dataset.controlsBound === 'true') return;
        root.dataset.controlsBound = 'true';

        const tagShapeButtons = Array.from(
          root.querySelectorAll('[data-tag-shape-btn]')
        );
        const tagStyleButtons = Array.from(
          root.querySelectorAll('[data-tag-style-btn]')
        );
        const railWidthButtons = Array.from(
          root.querySelectorAll('[data-rail-width-btn]')
        );
        const railColorButtons = Array.from(
          root.querySelectorAll('[data-rail-color-btn]')
        );
        const techPreviewButtons = Array.from(
          root.querySelectorAll('[data-tech-preview-btn]')
        );
        if (
          tagShapeButtons.length === 0 &&
          tagStyleButtons.length === 0 &&
          railWidthButtons.length === 0 &&
          railColorButtons.length === 0 &&
          techPreviewButtons.length === 0
        ) {
          return;
        }
        const shapeKey = 'thohol.stackTagShape';
        const shapeAllowed = new Set([
          'ultra',
          'ultra-rounded',
          'ultra-soft',
          'ultra-slab',
        ]);
        const styleKey = 'thohol.stackTagStyle';
        const styleAllowed = new Set(['tinted', 'clean', 'clean-tinted-hover']);
        const railWidthKey = 'thohol.stackRailWidth';
        const railWidthAllowed = new Set(['thin', 'thick', 'none']);
        const railColorKey = 'thohol.stackRailColor';
        const railColorAllowed = new Set(['context', 'black', 'blue']);
        const techPreviewKey = 'thohol.stackTechPreview';
        const techPreviewAllowed = new Set(['wrap', 'truncate']);

        const applyTagShape = (shape) => {
          if (!shapeAllowed.has(shape)) shape = 'ultra';
          root.setAttribute('data-tag-shape', shape);
          for (const b of tagShapeButtons) {
            b.setAttribute(
              'data-active',
              b.dataset.tagShapeBtn === shape ? 'true' : 'false'
            );
          }
        };

        const applyTagStyle = (style) => {
          if (!styleAllowed.has(style)) style = 'tinted';
          root.setAttribute('data-tag-style', style);
          for (const b of tagStyleButtons) {
            b.setAttribute(
              'data-active',
              b.dataset.tagStyleBtn === style ? 'true' : 'false'
            );
          }
        };

        const applyRailWidth = (width) => {
          if (!railWidthAllowed.has(width)) width = 'thin';
          root.setAttribute('data-rail-width', width);
          for (const b of railWidthButtons) {
            b.setAttribute(
              'data-active',
              b.dataset.railWidthBtn === width ? 'true' : 'false'
            );
          }
        };

        const applyRailColor = (color) => {
          if (!railColorAllowed.has(color)) color = 'context';
          root.setAttribute('data-rail-color', color);
          for (const b of railColorButtons) {
            b.setAttribute(
              'data-active',
              b.dataset.railColorBtn === color ? 'true' : 'false'
            );
          }
        };

        const applyTechPreview = (mode) => {
          if (!techPreviewAllowed.has(mode)) mode = 'wrap';
          root.setAttribute('data-tech-preview', mode);
          for (const b of techPreviewButtons) {
            b.setAttribute(
              'data-active',
              b.dataset.techPreviewBtn === mode ? 'true' : 'false'
            );
          }
          window.dispatchEvent(new CustomEvent('stack:tech-preview-changed'));
        };

        for (const b of tagShapeButtons) {
          b.addEventListener('click', () => {
            const shape = b.getAttribute('data-tag-shape-btn') || 'ultra';
            try {
              localStorage.setItem(shapeKey, shape);
            } catch (e) {
              void e;
            }
            applyTagShape(shape);
          });
        }

        for (const b of tagStyleButtons) {
          b.addEventListener('click', () => {
            const style = b.getAttribute('data-tag-style-btn') || 'tinted';
            try {
              localStorage.setItem(styleKey, style);
            } catch (e) {
              void e;
            }
            applyTagStyle(style);
          });
        }

        for (const b of railWidthButtons) {
          b.addEventListener('click', () => {
            const width = b.getAttribute('data-rail-width-btn') || 'thin';
            try {
              localStorage.setItem(railWidthKey, width);
            } catch (e) {
              void e;
            }
            applyRailWidth(width);
          });
        }

        for (const b of railColorButtons) {
          b.addEventListener('click', () => {
            const color = b.getAttribute('data-rail-color-btn') || 'context';
            try {
              localStorage.setItem(railColorKey, color);
            } catch (e) {
              void e;
            }
            applyRailColor(color);
          });
        }

        for (const b of techPreviewButtons) {
          b.addEventListener('click', () => {
            const mode = b.getAttribute('data-tech-preview-btn') || 'wrap';
            try {
              localStorage.setItem(techPreviewKey, mode);
            } catch (e) {
              void e;
            }
            applyTechPreview(mode);
          });
        }

        let initialShape = 'ultra';
        try {
          const storedShape = localStorage.getItem(shapeKey);
          if (storedShape) initialShape = storedShape;
        } catch (e) {
          void e;
        }

        let initialStyle = 'tinted';
        try {
          const storedStyle = localStorage.getItem(styleKey);
          if (storedStyle) initialStyle = storedStyle;
        } catch (e) {
          void e;
        }

        let initialRailWidth = 'thin';
        try {
          const storedRailWidth = localStorage.getItem(railWidthKey);
          if (storedRailWidth) initialRailWidth = storedRailWidth;
        } catch (e) {
          void e;
        }

        let initialRailColor = 'context';
        try {
          const storedRailColor = localStorage.getItem(railColorKey);
          if (storedRailColor) initialRailColor = storedRailColor;
        } catch (e) {
          void e;
        }
        let initialTechPreview = 'wrap';
        try {
          const storedTechPreview = localStorage.getItem(techPreviewKey);
          if (storedTechPreview) initialTechPreview = storedTechPreview;
        } catch (e) {
          void e;
        }

        applyTagShape(initialShape);
        applyTagStyle(initialStyle);
        applyRailWidth(initialRailWidth);
        applyRailColor(initialRailColor);
        applyTechPreview(initialTechPreview);
      }

      initStackControls();
      document.addEventListener('astro:page-load', initStackControls);
      document.addEventListener('DOMContentLoaded', initStackControls);
    </script>
  </main>
</BaseLayout>

<style>
  .intro p {
    margin: 0;
    color: var(--ink-soft);
  }

  .stack-wrap {
    margin-top: 1rem;
    display: grid;
    gap: 1.2rem;
  }

  .variant {
    display: flex;
    align-items: start;
    justify-content: space-between;
    gap: 0.9rem;
    flex-wrap: wrap;
    border: 1px solid var(--line);
    border-radius: 14px;
    background: color-mix(in srgb, var(--panel) 75%, #f4f7fc);
    padding: 0.6rem 0.75rem;
  }

  .variant-control {
    display: grid;
    gap: 0.35rem;
    min-width: 0;
  }

  .variant-label {
    margin: 0;
    font-family: var(--font-mono);
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--ink-soft);
  }

  .variant-buttons {
    display: inline-flex;
    gap: 0.35rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .variant-buttons button {
    appearance: none;
    border: 1px solid var(--line);
    background: var(--panel);
    color: var(--ink-soft);
    padding: 0.35rem 0.65rem;
    border-radius: 999px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 0.82rem;
  }

  .variant-buttons button[data-active='true'] {
    color: var(--ink);
    border-color: var(--accent);
    background: color-mix(in srgb, var(--accent) 12%, var(--panel));
  }

  .tag-shape-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(96px, 1fr));
    width: min(560px, 100%);
    gap: 0.35rem;
  }

  .tag-shape-buttons button {
    justify-content: center;
  }

  :global(.stack-wrap[data-tag-style='tinted'] .tech-badge) {
    border-color: color-mix(in srgb, var(--tag-accent) 32%, var(--line));
    background: color-mix(in srgb, var(--tag-accent) 8%, var(--panel));
  }

  :global(.stack-wrap[data-tag-style='tinted'] .tech-badge:hover) {
    border-color: color-mix(in srgb, var(--tag-accent) 62%, var(--line));
    background: color-mix(in srgb, var(--tag-accent) 14%, var(--panel));
  }

  :global(.stack-wrap[data-tag-style='clean'] .tech-badge) {
    background: transparent;
    border-color: color-mix(in srgb, var(--ink) 18%, var(--line));
    font-family: var(--font-mono);
  }

  :global(.stack-wrap[data-tag-style='clean'] .tech-badge:hover) {
    border-color: var(--ink);
    background: transparent;
  }

  :global(.stack-wrap[data-tag-style='clean-tinted-hover'] .tech-badge) {
    background: transparent;
    border-color: color-mix(in srgb, var(--ink) 18%, var(--line));
    font-family: var(--font-mono);
  }

  :global(.stack-wrap[data-tag-style='clean-tinted-hover'] .tech-badge:hover) {
    border-color: color-mix(in srgb, var(--tag-accent) 62%, var(--line));
    background: color-mix(in srgb, var(--tag-accent) 14%, var(--panel));
  }

  :global(.stack-wrap[data-tag-shape='ultra'] .tech-badge) {
    --tag-height: 21px;
    --tag-radius: 999px;
    --tag-pad-y: 1px;
    --tag-pad-right: 7px;
    --tag-pad-left: 12px;
    --dot-size: 3px;
    --dot-left: 5px;
    --dot-ring: 1px;
    --icon-size: 10px;
    font-size: 0.66rem;
  }

  :global(.stack-wrap[data-tag-shape='ultra-rounded'] .tech-badge) {
    --tag-height: 21px;
    --tag-radius: 7px;
    --tag-pad-y: 1px;
    --tag-pad-right: 7px;
    --tag-pad-left: 12px;
    --dot-size: 3px;
    --dot-left: 5px;
    --dot-ring: 1px;
    --icon-size: 10px;
    font-size: 0.66rem;
  }

  :global(.stack-wrap[data-tag-shape='ultra-soft'] .tech-badge) {
    --tag-height: 21px;
    --tag-radius: 5px;
    --tag-pad-y: 1px;
    --tag-pad-right: 7px;
    --tag-pad-left: 12px;
    --dot-size: 3px;
    --dot-left: 5px;
    --dot-ring: 1px;
    --icon-size: 10px;
    font-size: 0.66rem;
  }

  :global(.stack-wrap[data-tag-shape='ultra-slab'] .tech-badge) {
    --tag-height: 21px;
    --tag-radius: 2px;
    --tag-pad-y: 1px;
    --tag-pad-right: 7px;
    --tag-pad-left: 12px;
    --dot-size: 3px;
    --dot-left: 5px;
    --dot-ring: 1px;
    --icon-size: 10px;
    font-size: 0.66rem;
  }

  .section-head h2 {
    margin: 0 0 0.25rem;
  }

  .section-head p {
    margin: 0;
    color: var(--ink-soft);
  }

  .rows,
  .history-list {
    margin-top: 0.8rem;
    display: grid;
    gap: 0.55rem;
  }

  .empty {
    margin-top: 1rem;
    color: var(--ink-soft);
  }

  /* Clean stack layout (single display variant) */
  :global(.stack-wrap[data-stack-variant='v2'] .variant) {
    border-radius: 10px;
    background: transparent;
    border-color: color-mix(in srgb, var(--line) 85%, transparent);
  }

  :global(.stack-wrap[data-stack-variant='v2'] .rows),
  :global(.stack-wrap[data-stack-variant='v2'] .history-list) {
    gap: 0.85rem;
    border-top: 0;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-wrap) {
    position: relative;
    padding-left: 0.85rem;
  }

  :global(.stack-wrap[data-rail-width='none'] .row-wrap) {
    padding-left: 0;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-wrap::before) {
    content: '';
    position: absolute;
    left: 0;
    top: 10px;
    bottom: 10px;
    width: 3px;
    border-radius: 999px;
    background: color-mix(in srgb, var(--stack-accent) 35%, transparent);
    transform: scaleY(0.92);
    transform-origin: top center;
    transition:
      transform 380ms cubic-bezier(0.33, 0, 0.67, 1),
      background-color 320ms cubic-bezier(0.33, 0, 0.67, 1);
  }

  :global(
    .stack-wrap[data-stack-variant='v2']
      .row-wrap:has(.row[data-open='true'])::before
  ),
  :global(
    .stack-wrap[data-stack-variant='v2']
      .row-wrap:has(details.history[open])::before
  ) {
    transform: scaleY(1);
  }

  :global(.stack-wrap[data-rail-width='thin'] .row-wrap::before) {
    width: 2px;
  }

  :global(.stack-wrap[data-rail-width='thick'] .row-wrap::before) {
    width: 6px;
  }

  :global(.stack-wrap[data-rail-width='none'] .row-wrap::before) {
    display: none;
  }

  :global(.stack-wrap[data-rail-color='context'] .row-wrap::before) {
    background: color-mix(in srgb, var(--stack-accent) 35%, transparent);
  }

  :global(.stack-wrap[data-rail-color='black'] .row-wrap::before) {
    background: color-mix(in srgb, var(--ink) 45%, transparent);
  }

  :global(.stack-wrap[data-rail-color='blue'] .row-wrap::before) {
    background: color-mix(in srgb, var(--accent) 45%, transparent);
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-wrap) {
    padding-top: 0;
    padding-bottom: 0;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row),
  :global(.stack-wrap[data-stack-variant='v2'] .history) {
    border: 0;
    border-radius: 0;
    box-shadow: none;
    background: transparent;
    overflow: visible;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-summary),
  :global(.stack-wrap[data-stack-variant='v2'] .history-summary) {
    padding-left: 0;
    padding-right: 0;
    border-bottom: 0;
  }

  :global(
    .stack-wrap[data-stack-variant='v2'] .row[data-open='true'] .row-summary
  ),
  :global(
    .stack-wrap[data-stack-variant='v2'] details.history[open] .history-summary
  ) {
    background: transparent;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-title),
  :global(.stack-wrap[data-stack-variant='v2'] .history-title) {
    font-weight: 600;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-right),
  :global(.stack-wrap[data-stack-variant='v2'] .history-right) {
    color: color-mix(in srgb, var(--ink) 55%, var(--ink-soft));
  }

  :global(.stack-wrap[data-stack-variant='v2'] .row-body),
  :global(.stack-wrap[data-stack-variant='v2'] .history-body) {
    padding-left: 0;
    padding-right: 0;
    padding-top: 0.7rem;
    padding-bottom: 1rem;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .group) {
    border: 0;
    padding: 0;
    background: transparent;
  }

  :global(.stack-wrap[data-stack-variant='v2'] .group-title) {
    margin-bottom: 0.3rem;
    color: color-mix(in srgb, var(--ink) 55%, var(--ink-soft));
  }
</style>
