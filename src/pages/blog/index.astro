---
import BaseLayout from '../../layouts/BaseLayout.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_TITLE } from '../../consts';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');
const posts = (
  import.meta.env.PROD
    ? allPosts.filter((post) => post.data.published !== false)
    : allPosts
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const postsByYear = posts.reduce(
  (acc, post) => {
    const year = String(post.data.pubDate.getFullYear());
    if (!acc[year]) acc[year] = [];
    acc[year].push(post);
    return acc;
  },
  {} as Record<string, typeof posts>
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout
  title={`Archive Â· ${SITE_TITLE}`}
  description="Full archive of blog posts grouped by year."
>
  <main>
    <section>
      <p class="kicker">Archive</p>
      <h1>All posts</h1>
      <p class="intro">
        Every article from this blog, grouped by publication year.
      </p>
    </section>

    {
      years.map((year) => (
        <section class="year-group">
          <h2>{year}</h2>
          <ul>
            {postsByYear[year].map((post) => (
              <li>
                <div>
                  <p class="meta">
                    <FormattedDate date={post.data.pubDate} />
                  </p>
                  <h3>
                    <a href={`/blog/${post.id}/`}>{post.data.title}</a>
                  </h3>
                  <p>{post.data.description}</p>
                </div>
              </li>
            ))}
          </ul>
        </section>
      ))
    }
  </main>
</BaseLayout>

<style>
  .kicker {
    margin: 0;
    color: var(--ink-soft);
    font-family: var(--font-mono);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    font-size: 0.75rem;
  }

  .intro {
    max-width: 60ch;
  }

  .year-group {
    margin-top: 1.4rem;
  }

  .year-group ul {
    list-style: none;
    margin: 0;
    padding: 0;
    border-top: 1px solid var(--line);
  }

  .year-group li {
    padding: 1rem 0.2rem;
    border-bottom: 1px solid var(--line);
    transition: background-color 140ms ease;
  }

  .year-group li:hover {
    background: color-mix(in srgb, var(--accent) 5%, transparent);
  }

  .meta {
    margin: 0;
    color: var(--ink-soft);
    font-size: 0.8rem;
    font-family: var(--font-mono);
  }

  h3 {
    margin: 0.2rem 0 0.45rem;
  }

  h3 a {
    text-decoration: none;
  }

  h3 a:hover {
    text-decoration: underline;
    text-decoration-thickness: 2px;
    text-underline-offset: 0.18rem;
  }

  p {
    margin: 0;
  }
</style>
