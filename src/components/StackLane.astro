---
import StackPeriodCard from './StackPeriodCard.astro';

type Category =
  | 'Languages'
  | 'Databases'
  | 'Backend'
  | 'Frontend'
  | 'Infra'
  | 'Tooling'
  | 'AI/Assistants';

type ResolvedTech = { key: string; label: string; href?: string };
type PeriodEvent = {
  dateIso: string;
  dateLabel: string;
  title: string;
  note?: string;
  tech: ResolvedTech[];
};
type PeriodDiff = {
  added: Record<Category, ResolvedTech[]>;
  removed: Record<Category, ResolvedTech[]>;
};
type PeriodView = {
  fromIso: string;
  toIso?: string;
  rangeLabel: string;
  summary?: string;
  stack: Record<Category, ResolvedTech[]>;
  events: PeriodEvent[];
  diff?: PeriodDiff;
};

interface Props {
  contextId: string;
  title: string;
  kind: 'employer' | 'personal' | 'project';
  depth?: number;
  current: PeriodView;
  past: PeriodView[];
  categoryOrder: Category[];
}

const {
  contextId,
  title,
  kind,
  depth = 0,
  current,
  past,
  categoryOrder,
} = Astro.props;

const kindLabel =
  kind === 'employer' ? 'Work' : kind === 'personal' ? 'Personal' : 'Project';
---

<section class="lane" data-depth={depth} aria-label={`${title} stack lane`}>
  <header class="lane-head">
    <div class="lane-title">
      <p class="lane-kicker">
        <span class="lane-kind">{kindLabel}</span>
        <span class="lane-id">{contextId}</span>
      </p>
      <h2 class="lane-name">{title}</h2>
    </div>
  </header>

  <div class="lane-body">
    <StackPeriodCard
      isCurrent={true}
      fromIso={current.fromIso}
      toIso={current.toIso}
      rangeLabel={current.rangeLabel}
      summary={current.summary}
      stack={current.stack}
      events={current.events}
      diff={current.diff}
      categoryOrder={categoryOrder}
    />

    {
      past.length > 0 && (
        <details class="past" aria-label="Past stack periods">
          <summary>
            Past periods <span class="past-count">({past.length})</span>
          </summary>
          <div class="past-list">
            {past.map((p) => (
              <StackPeriodCard
                isCurrent={false}
                fromIso={p.fromIso}
                toIso={p.toIso}
                rangeLabel={p.rangeLabel}
                summary={p.summary}
                stack={p.stack}
                events={p.events}
                diff={p.diff}
                categoryOrder={categoryOrder}
              />
            ))}
          </div>
        </details>
      )
    }
  </div>
</section>

<style>
  .lane {
    margin-top: 1.35rem;
  }

  .lane[data-depth='0'] {
    margin-top: 0;
  }

  .lane[data-depth='1'] {
    margin-left: 1rem;
  }

  .lane[data-depth='2'] {
    margin-left: 2rem;
  }

  .lane-head {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.65rem;
  }

  .lane-kicker {
    margin: 0 0 0.15rem;
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    align-items: center;
    font-family: var(--font-mono);
    color: var(--ink-soft);
    font-size: 0.8rem;
  }

  .lane-kind {
    letter-spacing: 0.08em;
    text-transform: uppercase;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 0.08rem 0.45rem;
    background: #f4f7fc;
  }

  .lane-id {
    letter-spacing: 0.02em;
  }

  .lane-name {
    margin: 0;
    font-size: 1.35rem;
  }

  .lane-body {
    display: grid;
    gap: 0.85rem;
  }

  details.past {
    border: 1px solid var(--line);
    border-radius: 12px;
    background: color-mix(in srgb, var(--panel) 85%, #f4f7fc);
    padding: 0.6rem 0.75rem;
  }

  details.past summary {
    cursor: pointer;
    user-select: none;
    font-family: var(--font-mono);
    font-size: 0.86rem;
    color: var(--ink-soft);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 0.18em;
  }

  .past-count {
    color: var(--ink);
  }

  .past-list {
    margin-top: 0.75rem;
    display: grid;
    gap: 0.85rem;
  }

  @media (max-width: 720px) {
    .lane[data-depth='1'],
    .lane[data-depth='2'] {
      margin-left: 0.6rem;
    }
  }
</style>
