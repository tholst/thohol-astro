---
import StackTechFold from './StackTechFold.astro';

type Category =
  | 'Languages'
  | 'Frameworks'
  | 'UI'
  | 'Data'
  | 'Identity'
  | 'Integrations'
  | 'Platforms/Hosting'
  | 'Infrastructure'
  | 'Tooling'
  | 'AI Tools'
  | 'AI Models/APIs';

type Tech = { key: string; label: string; href?: string; tags: Category[] };

interface Props {
  contextId: string;
  title: string;
  rangeLabel: string;
  summary?: string;
  tech: Tech[];
  events: Array<{
    dateIso: string;
    dateLabel: string;
    title: string;
    note?: string;
  }>;
}

const { contextId, title, rangeLabel, summary, tech, events } = Astro.props;

const panelId = `stack-row-panel-${contextId.replace(/[^a-zA-Z0-9_-]/g, '-')}`;
---

<section
  class="row"
  data-stack-row
  data-open="false"
  data-has-events={events.length > 0 ? 'true' : 'false'}
  aria-label={`${title} stack`}
>
  <header class="row-summary">
    <span class="row-left">
      <span class="row-title">{title}</span>
      <span class="row-range">{rangeLabel}</span>
    </span>

    <div class="row-inline-tech">
      <StackTechFold tech={tech} showToggle={false} />
    </div>

    <button
      type="button"
      class="row-toggle"
      data-row-toggle
      aria-expanded="false"
      aria-controls={panelId}
      aria-label={`Toggle ${title} details`}
    >
      <span class="row-chev" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
          <path
            d="M6 9l6 6 6-6"
            stroke="currentColor"
            stroke-width="1.8"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </span>
    </button>

    <div class="row-peek" aria-label="Stack summary">
      {summary && <p class="row-desc">{summary}</p>}
    </div>
  </header>

  <div
    class="row-body"
    id={panelId}
    data-row-panel
    hidden
    aria-hidden="true"
    style="display:none;"
  >
    {
      events.length > 0 && (
        <div class="row-events" aria-label="Events">
          <h4>Events</h4>
          <ul>
            {events.map((e) => (
              <li>
                <time datetime={e.dateIso}>{e.dateLabel}</time>
                <span>{e.title}</span>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </div>

  <script is:inline>
    function initStackRows() {
      const rows = Array.from(document.querySelectorAll('[data-stack-row]'));
      for (const row of rows) {
        if (row.dataset.bound === 'true') continue;
        row.dataset.bound = 'true';

        const btn = row.querySelector('[data-row-toggle]');
        const panel = row.querySelector('[data-row-panel]');
        const fold = row.querySelector('[data-tech-fold]');
        const summary = row.querySelector('.row-summary');
        if (!btn || !panel) continue;
        const hasEvents = row.getAttribute('data-has-events') === 'true';
        const prefersReduced = window.matchMedia?.(
          '(prefers-reduced-motion: reduce)'
        )?.matches;

        const captureSummaryRects = () => {
          const targets = [
            summary?.querySelector('.row-left'),
            summary?.querySelector('.row-peek'),
          ].filter(Boolean);
          const m = new Map();
          for (const el of targets) {
            m.set(el, el.getBoundingClientRect());
          }
          return m;
        };

        const animateSummaryFlip = (beforeRects) => {
          if (prefersReduced) return;
          for (const [el, before] of beforeRects.entries()) {
            const after = el.getBoundingClientRect();
            const dx = before.left - after.left;
            const dy = before.top - after.top;
            if (Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5) continue;
            el.animate(
              [
                { transform: `translate(${dx}px, ${dy}px)` },
                { transform: 'translate(0px, 0px)' },
              ],
              { duration: 380, easing: 'cubic-bezier(0.33, 0, 0.67, 1)' }
            );
          }
        };

        const setOpen = (nextOpen, animate = true) => {
          const shouldAnimate = animate && !prefersReduced;
          const beforeRects = shouldAnimate ? captureSummaryRects() : undefined;

          row.setAttribute('data-open', nextOpen ? 'true' : 'false');
          btn.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
          const showPanel = nextOpen && hasEvents;
          panel.hidden = !showPanel;
          panel.setAttribute('aria-hidden', showPanel ? 'false' : 'true');
          panel.style.display = showPanel ? 'grid' : 'none';

          // Drive the same tech fold from compact (collapsed) to grouped (expanded).
          if (fold && typeof fold.__setOpen === 'function') {
            fold.__setOpen(nextOpen, animate);
          } else if (fold) {
            fold.setAttribute('data-open', nextOpen ? 'true' : 'false');
          }

          if (beforeRects && shouldAnimate) {
            requestAnimationFrame(() =>
              requestAnimationFrame(() => animateSummaryFlip(beforeRects))
            );
          }
        };

        btn.addEventListener('click', () => {
          const isOpen = row.getAttribute('data-open') === 'true';
          setOpen(!isOpen, true);
        });

        if (summary) {
          summary.addEventListener('click', (e) => {
            const target = e.target;
            if (!target || typeof target.closest !== 'function') return;
            if (target.closest('button')) return;
            if (target.closest('a')) return;
            if (target.closest('[data-tech-fold]')) return;
            if (!target.closest('.row-left')) return;
            const isOpen = row.getAttribute('data-open') === 'true';
            setOpen(!isOpen, true);
          });
        }

        // Defensive initialization: force collapsed state on first paint.
        setOpen(false, false);
      }
    }

    initStackRows();
  </script>
</section>

<style>
  .row {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: var(--panel);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .row-summary {
    padding: 0.7rem 0.8rem 0.85rem;
    display: grid;
    gap: 0.6rem;
    grid-template-columns: minmax(180px, auto) minmax(0, 1fr) auto;
    align-items: start;
    position: relative;
  }

  .row-left {
    cursor: pointer;
  }

  .row-summary::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 1px;
    background: var(--line);
    transform: scaleX(0);
    transform-origin: center;
    opacity: 0;
    transition:
      transform 380ms cubic-bezier(0.33, 0, 0.67, 1),
      opacity 320ms cubic-bezier(0.33, 0, 0.67, 1);
  }

  .row-left {
    display: grid;
    min-width: 0;
    gap: 0.14rem;
    grid-column: 1 / 2;
    grid-row: 1;
  }

  .row-title {
    font-size: 1.05rem;
    font-weight: 650;
    line-height: 1.2;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .row-range {
    font-family: var(--font-mono);
    font-size: 0.82rem;
    line-height: 1.25;
    color: var(--ink-soft);
    font-weight: 400;
    display: block;
  }

  .row-inline-tech {
    min-width: 0;
    grid-column: 2 / 3;
    grid-row: 1;
  }

  .row-toggle {
    appearance: none;
    border: 0;
    background: transparent;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: inherit;
    padding: 0;
    width: 30px;
    height: 30px;
    grid-column: 3 / 4;
    grid-row: 1;
    justify-self: end;
  }

  .row-chev {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--ink-soft);
    transition: transform 320ms cubic-bezier(0.33, 0, 0.67, 1);
  }

  .row[data-open='true'] .row-summary {
    background: color-mix(in srgb, var(--panel) 70%, #f4f7fc);
    grid-template-columns: minmax(0, 1fr) auto;
  }

  .row[data-open='true'][data-has-events='true'] .row-summary::after {
    transform: scaleX(1);
    opacity: 1;
  }

  .row[data-open='true'] .row-left {
    grid-column: 1 / 2;
    grid-row: 1;
  }

  .row[data-open='true'] .row-toggle {
    grid-column: 2 / 3;
    grid-row: 1;
  }

  .row[data-open='true'] .row-peek {
    grid-column: 1 / -1;
    grid-row: 2;
  }

  .row[data-open='true'] .row-inline-tech {
    grid-column: 1 / -1;
    grid-row: 3;
  }

  :global(
    .stack-wrap[data-tech-placement='below']
      .row[data-open='false']
      .row-summary
  ) {
    grid-template-columns: minmax(0, 1fr) auto;
  }

  :global(
    .stack-wrap[data-tech-placement='below'] .row[data-open='false'] .row-left
  ) {
    grid-column: 1 / 2;
    grid-row: 1;
  }

  :global(
    .stack-wrap[data-tech-placement='below'] .row[data-open='false'] .row-toggle
  ) {
    grid-column: 2 / 3;
    grid-row: 1;
  }

  :global(
    .stack-wrap[data-tech-placement='below'] .row[data-open='false'] .row-peek
  ) {
    grid-column: 1 / -1;
    grid-row: 2;
  }

  :global(
    .stack-wrap[data-tech-placement='below']
      .row[data-open='false']
      .row-inline-tech
  ) {
    grid-column: 1 / -1;
    grid-row: 3;
  }

  .row[data-open='true'][data-has-events='false'] .row-summary {
    border-bottom: 0;
  }

  .row[data-open='true'] .row-chev {
    transform: rotate(180deg);
  }

  .row-peek {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.4rem;
    grid-column: 1 / -1;
  }

  .row-toggle:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--accent) 55%, transparent);
    outline-offset: 3px;
    border-radius: 10px;
  }

  .row-body {
    padding: 0.75rem 0.8rem 0.9rem;
    display: grid;
    gap: 0.7rem;
  }

  /* Defensive: never show events/details while collapsed. */
  .row[data-open='false'] .row-body,
  .row-body[hidden] {
    display: none !important;
  }

  .row-desc {
    margin: 0;
    color: var(--ink-soft);
  }

  .row-events h4 {
    margin: 0 0 0.35rem;
    font-family: var(--font-mono);
    font-size: 0.8rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--ink-soft);
  }

  .row-events ul {
    margin: 0;
    padding-left: 1.15rem;
    display: grid;
    gap: 0.35rem;
  }

  .row-events li {
    display: flex;
    gap: 0.55rem;
    flex-wrap: wrap;
    align-items: baseline;
  }

  .row-events time {
    font-family: var(--font-mono);
    font-size: 0.78rem;
    color: var(--ink-soft);
    border: 1px solid var(--line);
    background: #f4f7fc;
    border-radius: 999px;
    padding: 0.08rem 0.45rem;
  }

  .row[data-open='true'] .row-events {
    animation: row-events-fade-in 340ms cubic-bezier(0.33, 0, 0.67, 1);
    transform-origin: top left;
  }

  @keyframes row-events-fade-in {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .row[data-open='true'] .row-events {
      animation: none;
    }
  }

  @media (max-width: 720px) {
    .row-summary {
      grid-template-columns: minmax(0, 1fr) auto;
    }

    .row-left {
      grid-column: 1 / 2;
      grid-row: 1;
    }

    .row-toggle {
      grid-column: 2 / 3;
      grid-row: 1;
    }

    .row-inline-tech {
      grid-column: 1 / -1;
      grid-row: 2;
    }

    .row-peek {
      grid-row: 3;
    }

    .row-title {
      white-space: normal;
    }
  }
</style>
