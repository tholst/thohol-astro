---
import StackTechList from './StackTechList.astro';
import type { StackCategory as Category } from '../lib/stack-taxonomy';

type Tech = { key: string; label: string; href?: string; tags: Category[] };

interface Props {
  tech: Tech[];
  showToggle?: boolean;
  foldRole?: 'preview' | 'detail';
}

const { tech, showToggle = true, foldRole = 'detail' } = Astro.props;
---

<section
  class="tech-fold"
  data-tech-fold
  data-fold-role={foldRole}
  data-open="false"
  aria-label="Tech list"
>
  <div class="tech-fold__content" aria-label="Tech badges">
    <StackTechList tech={tech} />
  </div>

  {
    showToggle && (
      <button
        type="button"
        class="tech-fold__toggle"
        aria-expanded="false"
        aria-label="Toggle grouped tech view"
      >
        <span class="tech-fold__chev" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none">
            <path
              d="M6 9l6 6 6-6"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </span>
      </button>
    )
  }
</section>

<script>
  import '../scripts/stack/stack-tech-fold';
</script>

<style>
  .tech-fold {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto auto;
    gap: 0.6rem;
    align-items: center;
    min-width: 0;
  }

  .tech-fold__toggle {
    appearance: none;
    border: 0;
    background: transparent;
    cursor: pointer;
    width: 30px;
    height: 30px;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--ink-soft);
    transition:
      transform 140ms ease,
      color 140ms ease;
  }

  .tech-fold__toggle:hover {
    color: var(--ink);
  }

  .tech-fold__toggle:focus-visible {
    outline: 2px solid color-mix(in srgb, var(--accent) 55%, transparent);
    outline-offset: 3px;
  }

  .tech-fold[data-open='true'] .tech-fold__toggle {
    transform: rotate(180deg);
  }

  .tech-fold__content {
    min-width: 0;
  }

  /* Compact mode: flatten group boxes into a single row of badges. */
  .tech-fold[data-open='false'] :global(.tech-list__groups) {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    overflow: visible;
    padding-bottom: 0;
    mask-image: none;
  }

  .tech-fold[data-open='false'] :global(.group) {
    display: contents;
  }

  .tech-fold[data-open='false'] :global(.group-title) {
    display: none;
  }

  .tech-fold[data-open='false'] :global(.group-items) {
    display: contents;
  }

  /* Grouped mode: show the structured groups from StackTechList. */
  .tech-fold[data-open='true'] :global(.tech-list__groups) {
    display: grid;
    gap: 0.65rem;
  }

  @media (max-width: 720px) {
    .tech-fold {
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 0.35rem;
    }

    .tech-fold__toggle {
      justify-self: end;
    }
  }
</style>
